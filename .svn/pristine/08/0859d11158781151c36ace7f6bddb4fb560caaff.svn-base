package com.haaa.cloudmedical.dao.equipment;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.stereotype.Repository;

import com.haaa.cloudmedical.common.entity.Constant;
import com.haaa.cloudmedical.common.entity.Page;
import com.haaa.cloudmedical.common.util.BeanPropertyUtil;
import com.haaa.cloudmedical.entity.LungCapacity;

@Repository
public class LungCapacityDao extends EquipmentDao {

	public long add(LungCapacity lungCapacity) {
		Map<String, Object> map = new HashMap<String, Object>();
		BeanPropertyUtil.toMapFromObject(map, lungCapacity);
		return insert(map, "c_lung_capacity");
	}

	// /**
	// * 查询所有user_id的记录
	// * @param user_id
	// * @return
	// */
	// public List<Map<String, Object>> queryAllRecent(long user_id){
	// String sql = "SELECT DATE_FORMAT(A.create_date,'%Y-%m-%d %H:%i')
	// datetime";
	// for (int i = 0; i < Constant.LUNGCAPACITYPARAMS.length; i++) {
	// sql=sql+",B."+Constant.LUNGCAPACITYPARAMS[i]+",B."+Constant.LUNGCAPACITYPARAMS[i]+"_rate
	// ";
	// }
	// sql=sql+ " FROM c_equipment_use A,c_lung_capacity B "
	// + " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? AND "
	// + " DATE_SUB(NOW(),INTERVAL 7 DAY) <A.create_date AND A.create_date<NOW()
	// ORDER BY A.create_date DESC";
	// return jdbcTemplate.queryForList(sql,user_id);
	// }

	/**
	 * 查询最近数据 AND A.create_date<NOW()
	 * 
	 * @param user_id
	 * @return
	 */
	public List<Map<String, Object>> queryRecent(long user_id, String type, int recent) {
		String sql = "SELECT A.order_id,DATE_FORMAT(A.create_date,'%Y-%m-%d %H:%i') datetime,B." + type + " param," + type
				+ "_rate param_rate" + " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? AND "
				+ " DATE_SUB(NOW(),INTERVAL ? DAY) <A.create_date  ORDER BY A.create_date DESC";
		return jdbcTemplate.queryForList(sql, new Object[] { user_id, recent });
	}

	public List<Map<String, Object>> queryByMonth(Long user_id, String year_month, int pageno, int pagesize) {
		String sql = "SELECT B.equipment_use_order_id,A.order_id,A.create_date datetime,B.fvc,B.fvc_rate,B.fev1,B.fev1_rate,B.pef,B.pef_rate "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? AND "
				+ " DATE_FORMAT(A.create_date,'%Y-%m')=?  ORDER BY A.create_date DESC LIMIT ?,?";
		int start = (pageno - 1) * pagesize;
		return jdbcTemplate.queryForList(sql, user_id, year_month, start, pagesize);
	}

	public List<Map<String, Object>> pageQuery(long user_id, int pageno, int pagesize) {
		String sql = "SELECT B.equipment_use_order_id,A.order_id,A.create_date datetime,B.fvc,B.fvc_rate,B.fev1,B.fev1_rate,B.pef,B.pef_rate "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? ORDER BY A.create_date DESC LIMIT ?,?";
		int start = (pageno - 1) * pagesize;
		return jdbcTemplate.queryForList(sql, user_id, start, pagesize);
	}

	/*
	 * 查询一个年内有数据的月份
	 */
	public List<Map<String, Object>> queryMonth(long user_id) {
		String sql = "SELECT DISTINCT(DATE_FORMAT(A.create_date,'%Y-%m')) yearmonth "
				+ " FROM c_equipment_use A,c_lung_capacity B WHERE "
				+ " A.order_id=B.equipment_use_order_id AND A.user_id = ? AND "
				+ " DATE_SUB(NOW(),INTERVAL 1 YEAR) <A.create_date ORDER BY A.create_date DESC ";
		return jdbcTemplate.queryForList(sql, user_id);
	}
	
	public int pageNumber(String user_id,int pagesize){
		String sql= "SELECT COUNT(*) "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? ";
		int count = jdbcTemplate.queryForObject(sql, Integer.class, user_id);
		return count<1?0:((count-1)/pagesize)+1;
	}

	public int pageNumberByMonth(String user_id,String yearMonth,int pagesize){
		String sql= "SELECT COUNT(*) "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? AND DATE_FORMAT(A.create_date,'%Y-%m')=?  ";
		int count = jdbcTemplate.queryForObject(sql, Integer.class, user_id,yearMonth);
		return count<1?0:((count-1)/pagesize)+1;
	}
	
	public List<Map<String, Object>> getDataByTime(String user_id, String datemin, String datemax) {
		List<Object> list = new ArrayList<Object>();
		String sql = "SELECT A.order_id,A.create_date,B.fvc,B.fvc_rate,B.fev1,B.fev1_rate,B.pef,B.pef_rate "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? ";
		list.add(user_id);
		if (datemin != null && !datemin.equals("") && datemax != null && !datemax.equals("")) {
			sql += " AND DATE_ADD(A.create_date,INTERVAL 1 DAY)>? AND DATE_SUB(A.create_date,INTERVAL 1 DAY) <? ";
			list.add(datemin);
			list.add(datemax);
		} else if (datemin != null && !datemin.equals("")) {
			sql += " AND DATE_ADD(A.create_date,INTERVAL 1 DAY)>? ";
			list.add(datemin);
		} else if (datemax != null && !datemax.equals("")) {
			sql += " AND DATE_SUB(A.create_date,INTERVAL 1 DAY)<? ";
			list.add(datemax);
		} else {
			sql += " AND DATE_SUB(NOW(),INTERVAL ? DAY) <A.create_date ";
			list.add(Constant.RECENT);
		}
		sql += " ORDER BY A.create_date ASC ";
		return jdbcTemplate.queryForList(sql, list.toArray());
	}

	
	
	public Page pageQueryByTime(String user_id,String datemin,String datemax,int pageno,int pagesize){
		List<Object> list = new ArrayList<Object>();
		String sql = "SELECT A.order_id,DATE_FORMAT(A.create_date,'%Y-%m-%d %H:%i') datetime,B.fvc,B.fvc_rate,B.fev1,B.fev1_rate,B.pef,B.pef_rate "
				+ " FROM c_equipment_use A,c_lung_capacity B "
				+ " WHERE A.order_id=B.equipment_use_order_id AND A.user_id = ? ";
		list.add(user_id);
		if (datemin != null && !datemin.equals("") && datemax != null && !datemax.equals("")) {
			sql += " AND DATE_ADD(A.create_date,INTERVAL 1 DAY)>? AND DATE_SUB(A.create_date,INTERVAL 1 DAY) <? ";
			list.add(datemin);
			list.add(datemax);
		} else if (datemin != null && !datemin.equals("")) {
			sql += " AND DATE_ADD(A.create_date,INTERVAL 1 DAY)>? ";
			list.add(datemin);
		} else if (datemax != null && !datemax.equals("")) {
			sql += " AND DATE_SUB(A.create_date,INTERVAL 1 DAY)<? ";
			list.add(datemax);
		} else {
			sql += " AND DATE_SUB(NOW(),INTERVAL ? DAY) <A.create_date ";
			list.add(Constant.RECENT);
		}
		sql += " ORDER BY A.create_date DESC ";
		return super.pageQuery(sql, list.toArray(), pageno, pagesize);
	}
	
}
